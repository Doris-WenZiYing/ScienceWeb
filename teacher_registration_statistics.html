<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>Â†±ÂêçÊï∏ÊìöÁµ±Ë®à - ËÄÅÂ∏´Á≥ªÁµ±</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="notification-center.js" defer></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        font-family: "Microsoft JhengHei", "Arial", sans-serif;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      }
      .header {
        height: 70px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 100;
      }
      .header::before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
      }
      .header img.logo {
        height: 50px;
        filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
        transition: transform 0.3s ease;
      }
      .header img.logo:hover {
        transform: scale(1.05);
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 25px;
        position: relative;
      }
      .icon-wrapper {
        position: relative;
      }
      .icon {
        position: relative;
        padding: 10px;
        border-radius: 50%;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .icon:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(17, 153, 142, 0.5);
      }
      .icon i {
        font-size: 18px;
        color: white;
      }
      .notification-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
        color: white;
        border-radius: 50%;
        width: 26px;
        height: 26px;
        font-size: 12px;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 4px 12px rgba(255, 71, 87, 0.5);
        animation: badgePulse 2s infinite;
      }
      .notification-badge.active {
        display: flex;
      }
      @keyframes badgePulse {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 4px 12px rgba(255, 71, 87, 0.5);
        }
        50% {
          transform: scale(1.2);
          box-shadow: 0 6px 20px rgba(255, 71, 87, 0.8);
        }
      }
      .notification-panel {
        position: absolute;
        top: 65px;
        right: 0;
        background: white;
        border-radius: 15px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        display: none;
        width: 400px;
        max-height: 550px;
        z-index: 1001;
        overflow: hidden;
        animation: panelFade 0.3s ease;
        flex-direction: column;
      }
      @keyframes panelFade {
        from {
          opacity: 0;
          transform: translateY(-15px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .notification-panel.active {
        display: flex;
      }
      .notification-header {
        padding: 20px 25px;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }
      .notification-header h3 {
        font-size: 17px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .notification-header i {
        font-size: 20px;
      }
      .mark-all-read {
        background: rgba(255, 255, 255, 0.25);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 7px 14px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      .mark-all-read:hover {
        background: rgba(255, 255, 255, 0.35);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
      }
      .notification-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }
      .notification-item {
        padding: 16px;
        margin-bottom: 8px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #f8f9fa;
        border-left: 4px solid transparent;
        position: relative;
      }
      .notification-item:hover {
        background: #f0f1f2;
        transform: translateX(4px);
      }
      .notification-item.unread {
        background: linear-gradient(135deg, #e8f9f8 0%, #f0fffe 100%);
        border-left-color: #11998e;
        box-shadow: 0 2px 8px rgba(17, 153, 142, 0.15);
      }
      .notification-item.unread::after {
        content: "";
        position: absolute;
        top: 8px;
        right: 8px;
        width: 10px;
        height: 10px;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        border-radius: 50%;
        animation: unreadPulse 2s infinite;
      }
      @keyframes unreadPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.8;
        }
      }
      .notification-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }
      .notification-item-title {
        font-weight: 700;
        color: #333;
        flex: 1;
        margin-right: 10px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .notification-type-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: white;
        flex-shrink: 0;
      }
      .notification-type-icon.info {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      }
      .notification-type-icon.warning {
        background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
      }
      .notification-item-time {
        font-size: 12px;
        color: #999;
        white-space: nowrap;
      }
      .notification-item-message {
        font-size: 13px;
        color: #666;
        line-height: 1.5;
        margin-bottom: 10px;
        font-weight: 500;
      }
      .notification-actions {
        display: flex;
        gap: 8px;
      }
      .notification-btn {
        font-size: 11px;
        padding: 6px 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .notification-btn-read {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(17, 153, 142, 0.2);
      }
      .notification-btn-read:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(17, 153, 142, 0.4);
      }
      .notification-btn-clear {
        background: #ffe8e8;
        color: #d32f2f;
        box-shadow: 0 2px 8px rgba(211, 47, 47, 0.1);
      }
      .notification-btn-clear:hover {
        background: #ffcccb;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(211, 47, 47, 0.2);
      }
      .empty-notification {
        padding: 50px 20px;
        text-align: center;
        color: #999;
      }
      .empty-notification i {
        font-size: 45px;
        margin-bottom: 15px;
        opacity: 0.4;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .empty-notification p {
        font-weight: 600;
        font-size: 14px;
      }
      .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid #fff;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .avatar:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(17, 153, 142, 0.3);
      }
      .avatar i {
        font-size: 20px;
        color: white;
      }
      .dropdown {
        position: absolute;
        top: 65px;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: none;
        min-width: 120px;
        z-index: 1000;
        overflow: hidden;
        animation: dropdownFade 0.3s ease;
      }
      @keyframes dropdownFade {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .dropdown a {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      .dropdown a:hover {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
      }
      .dropdown a i {
        margin-right: 8px;
        width: 16px;
      }
      .main {
        display: flex;
        height: calc(100% - 70px);
        gap: 0;
      }
      .sidebar {
        width: 250px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 30px 0;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .sidebar::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #11998e 0%, #38ef7d 100%);
      }
      .sidebar h2 {
        font-size: 16px;
        margin: 0;
        padding: 18px 30px;
        color: #555;
        font-weight: 400;
        text-align: left;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 15px;
        border-left: 4px solid transparent;
      }
      .sidebar h2 i {
        font-size: 17px;
        color: #555;
        width: 20px;
        text-align: center;
      }
      .sidebar h2:hover {
        color: #11998e;
        background: rgba(17, 153, 142, 0.1);
        border-left: 4px solid #11998e;
        transform: translateX(5px);
      }
      .sidebar h2:hover i {
        color: #11998e;
      }
      .menu a {
        display: flex;
        align-items: center;
        padding: 18px 30px;
        text-decoration: none;
        color: #555;
        font-size: 16px;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        position: relative;
      }
      .menu a:hover,
      .menu a.active {
        color: #11998e;
        background: rgba(17, 153, 142, 0.1);
        border-left: 4px solid #11998e;
        transform: translateX(5px);
      }
      .menu a i {
        margin-right: 15px;
        width: 20px;
        font-size: 18px;
      }
      .content {
        flex: 1;
        padding: 40px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      .statistics-container {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 30px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .page-title {
        font-size: 28px;
        color: #333;
        font-weight: 300;
        display: flex;
        align-items: center;
      }
      .page-title i {
        margin-right: 15px;
        color: #11998e;
        font-size: 32px;
      }
      .header-time {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 10px rgba(17, 153, 142, 0.3);
      }
      .header-time i {
        font-size: 16px;
      }
      .time-filter {
        background: rgba(248, 249, 250, 0.8);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }
      .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .filter-label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }
      .filter-select,
      .filter-input {
        padding: 10px 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
      }
      .filter-select:focus,
      .filter-input:focus {
        outline: none;
        border-color: #11998e;
        box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn-primary {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
      }
      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }
      .stat-icon {
        font-size: 48px;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .stat-number {
        font-size: 36px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }
      .stat-label {
        color: #666;
        font-size: 14px;
        font-weight: 600;
      }
      .stat-trend {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        margin-top: 10px;
        font-size: 12px;
        font-weight: 600;
      }
      .trend-up {
        color: #28a745;
      }
      .trend-down {
        color: #dc3545;
      }
      .charts-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }
      .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
      }
      .chart-title i {
        margin-right: 10px;
        color: #11998e;
      }
      .chart-wrapper {
        position: relative;
        height: 300px;
      }
      .data-table-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .table-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        display: flex;
        align-items: center;
      }
      .table-title i {
        margin-right: 10px;
        color: #11998e;
      }
      .table-actions {
        display: flex;
        gap: 10px;
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      .data-table th,
      .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }
      .data-table th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }
      .data-table td {
        color: #666;
        font-size: 14px;
      }
      .data-table tr:hover {
        background: rgba(17, 153, 142, 0.05);
      }
      .status-badge {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .badge-high {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }
      .badge-medium {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
      }
      .badge-low {
        background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
        color: white;
      }
      @media (max-width: 1200px) {
        .charts-section {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 768px) {
        .main {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
          height: auto;
        }
        .menu {
          display: flex;
          overflow-x: auto;
        }
        .menu a {
          white-space: nowrap;
          padding: 15px 20px;
        }
        .content {
          padding: 20px;
        }
        .time-filter {
          flex-direction: column;
          align-items: stretch;
        }
        .filter-group {
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
        }
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .notification-panel {
          width: 320px;
        }
      }
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
      }
    </style>
  </head>
  <body class="teacher-page">
    <div class="header">
      <a href="teacher_dashboard.html"
        ><img src="image/logo1.gif" alt="Logo" class="logo"
      /></a>
      <div class="header-right">
        <div class="icon-wrapper">
          <div class="icon" id="notificationBell">
            <i class="fas fa-bell"></i>
          </div>
          <div class="notification-badge" id="notificationBadge">0</div>
        </div>
        <div class="notification-panel" id="notificationPanel">
          <div class="notification-header">
            <h3><i class="fas fa-bell"></i> ÈÄöÁü•‰∏≠ÂøÉ</h3>
            <button class="mark-all-read">
              <i class="fas fa-check-double"></i> ÂÖ®ÈÉ®Â∑≤ËÆÄ
            </button>
          </div>
          <div class="notification-list" id="notificationList">
            <div class="empty-notification">
              <i class="fas fa-inbox"></i>
              <p>ËºâÂÖ•‰∏≠...</p>
            </div>
          </div>
        </div>
        <div class="avatar" id="avatar"><i class="fas fa-user"></i></div>
        <div class="dropdown" id="dropdown">
          <a href="login_teacher.html"
            ><i class="fas fa-sign-out-alt"></i>ÁôªÂá∫</a
          >
        </div>
      </div>
    </div>

    <div class="main">
      <div class="sidebar">
        <h2 onclick="location.href='teacher_dashboard.html';">
          <i class="fas fa-home"></i>ËÄÅÂ∏´È¶ñÈ†Å
        </h2>
        <div class="menu">
          <a href="teacher_activity_status.html"
            ><i class="fas fa-chart-bar"></i>Êü•ÁúãÊ¥ªÂãïÊÉÖÊ≥Å</a
          >
          <a href="teacher_registration_statistics.html" class="active"
            ><i class="fas fa-users"></i>Â†±ÂêçÊï∏ÊìöÁµ±Ë®à</a
          >
          <a href="teacher_form_feedback.html"
            ><i class="fas fa-comments"></i>Â≠∏ÁîüË°®ÂñÆÂèçÈ•ã</a
          >
          <a href="teacher_schedules_classes.html"
            ><i class="fas fa-calendar-alt"></i>Á∑ö‰∏äÊéíÁè≠</a
          >
          <a href="teacher_ask_for_leave.html"
            ><i class="fas fa-clipboard-check"></i>Ë´ãÂÅáÂØ©Ê†∏</a
          >
          <a href="teacher_rollcall.html"
            ><i class="fas fa-user-check"></i>ÈªûÂêçÁ≥ªÁµ±</a
          >
          <a href="teacher_working_hours.html"
            ><i class="fas fa-clock"></i>Â∑•‰ΩúÊôÇÊï∏ËàáÂá∫Â∏≠Ë®òÈåÑ</a
          >
        </div>
      </div>

      <div class="content">
        <div class="statistics-container">
          <div class="page-header">
            <div class="page-title">
              <i class="fas fa-chart-pie"></i>Â†±ÂêçÊï∏ÊìöÁµ±Ë®à
            </div>
            <div class="header-time" id="currentTime">
              <i class="fas fa-clock"></i><span id="timeText"></span>
            </div>
          </div>

          <div class="time-filter">
            <div class="filter-group">
              <label class="filter-label">ÊôÇÈñìÁØÑÂúçÔºö</label>
              <select
                class="filter-select"
                id="timeRange"
                onchange="handleTimeRangeChange()"
              >
                <option value="week">Êú¨ÈÄ±</option>
                <option value="month" selected>Êú¨Êúà</option>
                <option value="quarter">Êú¨Â≠£</option>
                <option value="year">Êú¨Âπ¥</option>
                <option value="custom">Ëá™Ë®ÇÁØÑÂúç</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">ÈñãÂßãÊó•ÊúüÔºö</label>
              <input type="date" class="filter-input" id="startDate" />
            </div>
            <div class="filter-group">
              <label class="filter-label">ÁµêÊùüÊó•ÊúüÔºö</label>
              <input type="date" class="filter-input" id="endDate" />
            </div>
            <div class="filter-group">
              <label class="filter-label">Ê¥ªÂãïÈ°ûÂà•Ôºö</label>
              <select class="filter-select" id="categoryFilter">
                <option value="">ÂÖ®ÈÉ®È°ûÂà•</option>
                <option value="competition">ÊØîË≥Ω</option>
                <option value="activity">Ê¥ªÂãï</option>
                <option value="workshop">Â∑•‰ΩúÂùä</option>
                <option value="seminar">Ë¨õÂ∫ß</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="updateStatistics()">
              <i class="fas fa-sync-alt"></i>Êõ¥Êñ∞Êï∏Êìö
            </button>
            <button class="btn btn-secondary" onclick="exportData()">
              <i class="fas fa-download"></i>ÂåØÂá∫Â†±Ë°®
            </button>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon"><i class="fas fa-users"></i></div>
              <div class="stat-number" id="totalRegistrations">-</div>
              <div class="stat-label">Á∏ΩÂ†±Âêç‰∫∫Ê¨°</div>
              <div
                class="stat-trend"
                id="trendRegistrations"
                style="display: none"
              >
                <i class="fas fa-arrow-up"></i>
                <span>+0%</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
              <div class="stat-number" id="activeActivities">-</div>
              <div class="stat-label">Ê¥ªË∫çÊ¥ªÂãïÊï∏</div>
              <div
                class="stat-trend"
                id="trendActivities"
                style="display: none"
              >
                <i class="fas fa-arrow-up"></i>
                <span>+0%</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fas fa-percentage"></i></div>
              <div class="stat-number" id="avgFillRate">-</div>
              <div class="stat-label">Âπ≥ÂùáÂ†±ÂêçÁéá</div>
              <div class="stat-trend" id="trendFillRate" style="display: none">
                <i class="fas fa-arrow-up"></i>
                <span>+0%</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fas fa-user-graduate"></i></div>
              <div class="stat-number" id="totalParticipants">-</div>
              <div class="stat-label">Á∏ΩÂèÉËàá‰∫∫Êï∏</div>
              <div
                class="stat-trend"
                id="trendParticipants"
                style="display: none"
              >
                <i class="fas fa-arrow-up"></i>
                <span>+0%</span>
              </div>
            </div>
          </div>

          <div class="charts-section">
            <div class="chart-container">
              <div class="chart-title">
                <i class="fas fa-calendar-week"></i>Â†±ÂêçË∂®Âã¢
              </div>
              <div class="chart-wrapper">
                <canvas id="weeklyChart"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <div class="chart-title">
                <i class="fas fa-pie-chart"></i>Ê¥ªÂãïÈ°ûÂà•ÂàÜ‰Ωà
              </div>
              <div class="chart-wrapper">
                <canvas id="categoryChart"></canvas>
              </div>
            </div>
          </div>

          <div class="data-table-section">
            <div class="table-header">
              <div class="table-title">
                <i class="fas fa-table"></i>Ê¥ªÂãïÂ†±ÂêçË©≥Á¥∞Êï∏Êìö
              </div>
              <div class="table-actions">
                <button class="btn btn-secondary" onclick="updateStatistics()">
                  <i class="fas fa-refresh"></i>ÈáçÊñ∞Êï¥ÁêÜ
                </button>
              </div>
            </div>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ê¥ªÂãïÂêçÁ®±</th>
                  <th>È°ûÂà•</th>
                  <th>Â†±Âêç‰∫∫Êï∏</th>
                  <th>ÂÆπÈáè</th>
                  <th>Â†±ÂêçÁéá</th>
                  <th>ÈñãÂßãÊó•Êúü</th>
                  <th>ÁãÄÊÖã</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px">
                    ËºâÂÖ•‰∏≠...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "teacher_api.php";
      let weeklyChart, categoryChart;
      let currentStatsData = null;
      let currentRangeType = "month";

      const categoryMap = {
        competition: "ÊØîË≥Ω",
        activity: "Ê¥ªÂãï",
        workshop: "Â∑•‰ΩúÂùä",
        seminar: "Ë¨õÂ∫ß",
      };

      const statusMap = {
        draft: "ËçâÁ®ø",
        published: "ÈÄ≤Ë°å‰∏≠",
        closed: "Â∑≤ÈóúÈñâ",
        cancelled: "Â∑≤ÂèñÊ∂à",
      };

      window.addEventListener("load", () => {
        console.log("üöÄ === È†ÅÈù¢ËºâÂÖ• ===");
        initDateFilters();
        updateTime();
        setInterval(updateTime, 1000);
        initCharts();
        loadRegistrationStats();
        loadActivitiesTable();
      });

      function initDateFilters() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

        document.getElementById("startDate").value = firstDay
          .toISOString()
          .split("T")[0];
        document.getElementById("endDate").value = lastDay
          .toISOString()
          .split("T")[0];

        console.log(
          "üìÖ Êó•ÊúüÁØÑÂúçÂ∑≤Ë®≠ÂÆö:",
          firstDay.toISOString().split("T")[0],
          "Âà∞",
          lastDay.toISOString().split("T")[0]
        );
      }

      function handleTimeRangeChange() {
        const range = document.getElementById("timeRange").value;
        const today = new Date();
        let startDate, endDate;

        currentRangeType = range;

        switch (range) {
          case "week":
            const firstDayOfWeek = new Date(today);
            firstDayOfWeek.setDate(today.getDate() - today.getDay() + 1);
            startDate = firstDayOfWeek;
            endDate = new Date(firstDayOfWeek);
            endDate.setDate(firstDayOfWeek.getDate() + 6);
            break;
          case "month":
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
          case "quarter":
            const quarter = Math.floor(today.getMonth() / 3);
            startDate = new Date(today.getFullYear(), quarter * 3, 1);
            endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
            break;
          case "year":
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            break;
          case "custom":
            currentRangeType = "custom";
            return;
        }

        document.getElementById("startDate").value = startDate
          .toISOString()
          .split("T")[0];
        document.getElementById("endDate").value = endDate
          .toISOString()
          .split("T")[0];

        updateStatistics();
      }

      async function loadRegistrationStats() {
        try {
          const startDate = document.getElementById("startDate").value;
          const endDate = document.getElementById("endDate").value;
          const category = document.getElementById("categoryFilter").value;

          let url = `${API_BASE_URL}?action=get_registration_stats&start_date=${startDate}&end_date=${endDate}&range_type=${currentRangeType}`;
          if (category) url += `&category=${encodeURIComponent(category)}`;

          console.log("üì° Ë´ãÊ±ÇÁµ±Ë®àÊï∏Êìö:", url);
          console.log("üìÖ Êó•ÊúüÁØÑÂúç:", startDate, "Âà∞", endDate);
          console.log("‚è∞ ÁØÑÂúçÈ°ûÂûã:", currentRangeType);

          const response = await fetch(url);
          const responseText = await response.text();

          console.log(
            "üì• Êî∂Âà∞ÈüøÊáâÔºàÂâç500Â≠óÔºâ:",
            responseText.substring(0, 500)
          );

          let result;
          try {
            result = JSON.parse(responseText);
          } catch (parseError) {
            console.error("‚ùå JSON Ëß£ÊûêÈåØË™§:", parseError);
            console.error("ÂÆåÊï¥ÈüøÊáâÂÖßÂÆπ:", responseText);
            showNotification("‰º∫ÊúçÂô®ËøîÂõûÊ†ºÂºèÈåØË™§", "error");
            return;
          }

          console.log("üìä Ëß£ÊûêÂæåÁöÑÁµêÊûú:", result);

          if (result.success && result.data) {
            currentStatsData = result.data;

            if (result.data.debug) {
              console.log("üîç Ë™øË©¶‰ø°ÊÅØ:", result.data.debug);
            }

            updateStatsCards(result.data);
            updateCharts(result.data);
            console.log("‚úÖ Áµ±Ë®àÊï∏ÊìöËºâÂÖ•ÊàêÂäü");
          } else {
            console.error("‚ùå API ËøîÂõûÈåØË™§:", result.message);
            showNotification(result.message || "ËºâÂÖ•Áµ±Ë®àÊï∏ÊìöÂ§±Êïó", "error");
          }
        } catch (error) {
          console.error("‚ùå ËºâÂÖ•Áµ±Ë®àÊï∏ÊìöÂ§±Êïó:", error);
          showNotification("ÁÑ°Ê≥ïÈÄ£Êé•Âà∞‰º∫ÊúçÂô®: " + error.message, "error");
        }
      }

      async function loadActivitiesTable() {
        try {
          const url = `${API_BASE_URL}?action=get_activities`;
          console.log("üì° ËºâÂÖ•Ê¥ªÂãïÂàóË°®:", url);

          const response = await fetch(url);
          const activities = await response.json();

          if (Array.isArray(activities)) {
            populateTable(activities);
            console.log("‚úÖ Ê¥ªÂãïÂàóË°®ËºâÂÖ•ÊàêÂäü:", activities.length, "ÂÄãÊ¥ªÂãï");
          } else {
            console.error("‚ùå Ê¥ªÂãïÂàóË°®Ê†ºÂºèÈåØË™§");
            showNotification("Ê¥ªÂãïÂàóË°®ËºâÂÖ•Â§±Êïó", "error");
          }
        } catch (error) {
          console.error("‚ùå ËºâÂÖ•Ê¥ªÂãïÂàóË°®Â§±Êïó:", error);
          showNotification("ËºâÂÖ•Ê¥ªÂãïÂàóË°®Â§±Êïó", "error");
        }
      }

      function updateStatsCards(data) {
        animateNumber("totalRegistrations", data.totalRegistrations || 0);
        animateNumber("activeActivities", data.activeActivities || 0);
        animateNumber("totalParticipants", data.totalParticipants || 0);

        const avgRate = data.avgFillRate || 0;
        document.getElementById("avgFillRate").textContent = avgRate + "%";

        updateTrend("trendRegistrations", data.registrationsTrend || 0);
        updateTrend("trendActivities", data.activitiesTrend || 0);
        updateTrend("trendFillRate", data.fillRateTrend || 0);
        updateTrend("trendParticipants", data.participantsTrend || 0);
      }

      function updateTrend(elementId, trendValue) {
        const element = document.getElementById(elementId);
        if (!element) return;

        element.style.display = "flex";
        const icon = element.querySelector("i");
        const span = element.querySelector("span");

        if (trendValue > 0) {
          element.className = "stat-trend trend-up";
          icon.className = "fas fa-arrow-up";
          span.textContent = `+${trendValue}%`;
        } else if (trendValue < 0) {
          element.className = "stat-trend trend-down";
          icon.className = "fas fa-arrow-down";
          span.textContent = `${trendValue}%`;
        } else {
          element.className = "stat-trend";
          icon.className = "fas fa-minus";
          span.textContent = "0%";
        }
      }

      function updateCharts(data) {
        console.log("üìä ÈñãÂßãÊõ¥Êñ∞ÂúñË°®ÔºåÊî∂Âà∞ÁöÑÊï∏Êìö:", data);
        console.log("‚è∞ Áï∂ÂâçÁØÑÂúçÈ°ûÂûã:", currentRangeType);

        if (weeklyChart && data.weeklyTrend) {
          const weeklyData = data.weeklyTrend;

          console.log("üìà ÈÄ±Ë∂®Âã¢ÂéüÂßãÊï∏Êìö:", weeklyData);

          if (weeklyData.length > 0) {
            const labels = weeklyData.map((item) => item.day_name || "");
            const values = weeklyData.map((item) => parseInt(item.count) || 0);

            console.log("üìä ÈÄ±Ë∂®Âã¢Ê®ôÁ±§:", labels);
            console.log("üìä ÈÄ±Ë∂®Âã¢Êï∏ÂÄº:", values);

            let chartLabel = "Â†±Âêç‰∫∫Êï∏";
            switch (currentRangeType) {
              case "week":
                chartLabel = "Êú¨ÈÄ±Â†±Âêç‰∫∫Êï∏";
                break;
              case "month":
                chartLabel = "Êú¨ÊúàÂ†±Âêç‰∫∫Êï∏";
                break;
              case "quarter":
                chartLabel = "Êú¨Â≠£Â†±Âêç‰∫∫Êï∏";
                break;
              case "year":
                chartLabel = "Êú¨Âπ¥Â†±Âêç‰∫∫Êï∏";
                break;
              default:
                chartLabel = "Â†±Âêç‰∫∫Êï∏";
            }

            weeklyChart.data.labels = labels;
            weeklyChart.data.datasets[0].data = values;
            weeklyChart.data.datasets[0].label = chartLabel;
          } else {
            weeklyChart.data.labels = ["Êö´ÁÑ°Êï∏Êìö"];
            weeklyChart.data.datasets[0].data = [0];
            weeklyChart.data.datasets[0].label = "Â†±Âêç‰∫∫Êï∏";
          }

          if (currentRangeType === "week") {
            weeklyChart.options.scales.y.ticks.stepSize = 5;
          } else {
            weeklyChart.options.scales.y.ticks.stepSize = undefined; // Ëá™Âãï
          }

          weeklyChart.update();
          console.log("‚úÖ ÈÄ±Ë∂®Âã¢ÂúñÊõ¥Êñ∞ÂÆåÊàê");
        }

        if (categoryChart && data.categoryDistribution) {
          const categoryData = data.categoryDistribution;

          console.log("ü•ß È°ûÂà•ÂàÜ‰ΩàÂéüÂßãÊï∏Êìö:", categoryData);

          if (categoryData.length > 0) {
            const labels = categoryData.map(
              (c) => categoryMap[c.activity_type] || c.activity_type || "Êú™ÂàÜÈ°û"
            );
            const values = categoryData.map((c) => parseInt(c.count) || 0);

            console.log("ü•ß È°ûÂà•Ê®ôÁ±§:", labels);
            console.log("ü•ß È°ûÂà•Êï∏ÂÄº:", values);

            const colors = ["#11998e", "#38ef7d", "#ffc107", "#dc3545"];
            const bgColors = values.map(
              (_, index) => colors[index % colors.length]
            );

            categoryChart.data.labels = labels;
            categoryChart.data.datasets[0].data = values;
            categoryChart.data.datasets[0].backgroundColor = bgColors;
          } else {
            categoryChart.data.labels = ["Êö´ÁÑ°Êï∏Êìö"];
            categoryChart.data.datasets[0].data = [1];
            categoryChart.data.datasets[0].backgroundColor = ["#cccccc"];
          }

          categoryChart.update();
          console.log("‚úÖ È°ûÂà•ÂàÜ‰ΩàÂúñÊõ¥Êñ∞ÂÆåÊàê");
        }
      }

      function populateTable(activities) {
        const tableBody = document.getElementById("tableBody");
        if (!activities || activities.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="7" style="text-align:center;padding:40px;">Êö´ÁÑ°Êï∏Êìö</td></tr>';
          return;
        }

        tableBody.innerHTML = activities
          .map((activity) => {
            const fillRate =
              activity.max_participants > 0
                ? (
                    (activity.current_participants /
                      activity.max_participants) *
                    100
                  ).toFixed(1)
                : 0;
            const statusBadge = getStatusBadge(fillRate);
            const statusText = statusMap[activity.status] || activity.status;
            const categoryText =
              categoryMap[activity.activity_type] ||
              activity.activity_type ||
              "Êú™ÂàÜÈ°û";

            return `
          <tr>
            <td>${activity.activity_name}</td>
            <td>${categoryText}</td>
            <td>${activity.current_participants || 0}</td>
            <td>${activity.max_participants || 0}</td>
            <td><span class="status-badge ${
              statusBadge.class
            }">${fillRate}%</span></td>
            <td>${activity.start_date || "-"}</td>
            <td>${statusText}</td>
          </tr>
        `;
          })
          .join("");
      }

      function getStatusBadge(fillRate) {
        if (fillRate >= 80) return { class: "badge-high", text: "È´ò" };
        if (fillRate >= 50) return { class: "badge-medium", text: "‰∏≠" };
        return { class: "badge-low", text: "‰Ωé" };
      }

      function initCharts() {
        console.log("üé® ÂàùÂßãÂåñÂúñË°®...");

        const weeklyCtx = document
          .getElementById("weeklyChart")
          .getContext("2d");
        weeklyChart = new Chart(weeklyCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Â†±Âêç‰∫∫Êï∏",
                data: [],
                borderColor: "#11998e",
                backgroundColor: "rgba(17, 153, 142, 0.1)",
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointBackgroundColor: "#11998e",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: {
                  usePointStyle: true,
                  padding: 15,
                  font: { size: 13, weight: "bold" },
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                padding: 12,
                titleFont: { size: 14, weight: "bold" },
                bodyFont: { size: 13 },
                callbacks: {
                  label: function (context) {
                    return (
                      context.dataset.label + ": " + context.parsed.y + "‰∫∫"
                    );
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: "rgba(0,0,0,0.05)", drawBorder: false },
                ticks: {
                  font: { size: 12 },
                  callback: function (value) {
                    return value + "‰∫∫";
                  },
                },
              },
              x: {
                grid: { color: "rgba(0,0,0,0.05)", drawBorder: false },
                ticks: {
                  font: { size: 12, weight: "bold" },
                },
              },
            },
          },
        });

        const categoryCtx = document
          .getElementById("categoryChart")
          .getContext("2d");
        categoryChart = new Chart(categoryCtx, {
          type: "doughnut",
          data: {
            labels: [],
            datasets: [
              {
                data: [],
                backgroundColor: ["#11998e", "#38ef7d", "#ffc107", "#dc3545"],
                borderWidth: 3,
                borderColor: "#ffffff",
                hoverOffset: 10,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                  font: { size: 13, weight: "bold" },
                  generateLabels: function (chart) {
                    const data = chart.data;
                    if (data.labels.length && data.datasets.length) {
                      return data.labels.map((label, i) => {
                        const value = data.datasets[0].data[i];
                        return {
                          text: `${label} (${value}ÂÄã)`,
                          fillStyle: data.datasets[0].backgroundColor[i],
                          hidden: false,
                          index: i,
                        };
                      });
                    }
                    return [];
                  },
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                padding: 12,
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const value = context.parsed || 0;
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0
                    );
                    const percentage =
                      total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value}ÂÄãÊ¥ªÂãï (${percentage}%)`;
                  },
                },
              },
            },
          },
        });

        console.log("‚úÖ ÂúñË°®ÂàùÂßãÂåñÂÆåÊàê");
      }

      function formatTimeAgo(dateString) {
        if (!dateString) return "ÂâõÂâõ";
        const date = new Date(dateString),
          now = new Date(),
          diff = now - date;
        const minutes = Math.floor(diff / 60000),
          hours = Math.floor(diff / 3600000),
          days = Math.floor(diff / 86400000);
        if (minutes < 1) return "ÂâõÂâõ";
        if (minutes < 60) return `${minutes}ÂàÜÈêòÂâç`;
        if (hours < 24) return `${hours}Â∞èÊôÇÂâç`;
        if (days < 7) return `${days}Â§©Ââç`;
        return date.toLocaleDateString("zh-TW");
      }

      function updateTime() {
        const now = new Date();
        const options = {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          weekday: "long",
        };
        document.getElementById("timeText").textContent =
          now.toLocaleDateString("zh-TW", options);
      }

      function animateNumber(elementId, targetValue) {
        const element = document.getElementById(elementId);
        const startValue =
          parseFloat(element.textContent.replace(/[^0-9.-]/g, "")) || 0;
        const increment = (targetValue - startValue) / 20;
        let currentValue = startValue;

        const timer = setInterval(() => {
          currentValue += increment;
          if (
            (increment > 0 && currentValue >= targetValue) ||
            (increment < 0 && currentValue <= targetValue) ||
            increment === 0
          ) {
            element.textContent = targetValue;
            clearInterval(timer);
          } else {
            element.textContent = Math.floor(currentValue);
          }
        }, 50);
      }

      function updateStatistics() {
        loadRegistrationStats();
        loadActivitiesTable();
        showNotification("Êï∏ÊìöÂ∑≤Êõ¥Êñ∞", "success");
      }

      function exportData() {
        showNotification("Ê≠£Âú®Ê∫ñÂÇôÂåØÂá∫Ê™îÊ°à...", "info");
        setTimeout(() => {
          showNotification("Â†±Ë°®Â∑≤ÂåØÂá∫Ëá≥‰∏ãËºâË≥áÊñôÂ§æ", "success");
        }, 2000);
      }

      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.style.cssText = `
        position:fixed;
        top:20px;
        right:20px;
        background:${
          type === "success"
            ? "linear-gradient(135deg,#28a745 0%,#20c997 100%)"
            : type === "error"
            ? "linear-gradient(135deg,#dc3545 0%,#e83e8c 100%)"
            : "linear-gradient(135deg,#17a2b8 0%,#6f42c1 100%)"
        };
        color:white;
        padding:15px 25px;
        border-radius:10px;
        box-shadow:0 4px 15px rgba(0,0,0,0.2);
        z-index:10000;
        font-weight:500;
        animation:slideIn 0.3s ease;
        cursor:pointer;
      `;
        notification.textContent = message;

        notification.addEventListener("click", () => {
          notification.style.animation = "slideOut 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        });

        if (!document.querySelector("#notificationStyles")) {
          const style = document.createElement("style");
          style.id = "notificationStyles";
          style.textContent = `
          @keyframes slideIn { 
            from { transform: translateX(100%); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
          } 
          @keyframes slideOut { 
            from { transform: translateX(0); opacity: 1; } 
            to { transform: translateX(100%); opacity: 0; } 
          }
        `;
          document.head.appendChild(style);
        }

        document.body.appendChild(notification);

        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = "slideOut 0.3s ease";
            setTimeout(() => notification.remove(), 300);
          }
        }, 3000);
      }
    </script>
  </body>
</html>
