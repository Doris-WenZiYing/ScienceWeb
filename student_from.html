<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ç§‘å­¸æœƒ - æ´»å‹•å›é¥‹è¡¨å–®</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
<style>
html, body { height:100%; margin:0; padding:0; font-family:'Microsoft JhengHei','Noto Sans TC',sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
.header { height:70px; background:linear-gradient(135deg,#fff 0%,#f8f9fa 100%); display:flex; align-items:center; justify-content:space-between; padding:0 30px; box-shadow:0 2px 20px rgba(0,0,0,0.1); position:relative; z-index:100; }
.header::before { content:''; position:absolute; bottom:0; left:0; right:0; height:3px; background:linear-gradient(90deg,#667eea 0%,#764ba2 100%); }
.header img.logo { height:50px; cursor:pointer; }
.header-right { display:flex; align-items:center; gap:25px; position:relative; }
.icon,.avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; }

.dropdown-menu { position:absolute; top:70px; right:0; background:white; border-radius:8px; box-shadow:0 5px 15px rgba(0,0,0,0.15); display:none; flex-direction:column; min-width:140px; z-index:200; }
.dropdown-menu a { padding:10px 15px; text-decoration:none; color:#333; display:block; font-size:14px; }
.dropdown-menu a:hover { background:#f5f5f5; color:#667eea; }

.main { display:flex; height:calc(100% - 70px); }

.sidebar { width:250px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); display:flex; flex-direction:column; padding-top:30px; overflow-y:auto; flex-shrink:0; min-height:0; scrollbar-width: thin; scrollbar-color: #667eea rgba(0,0,0,0.1);}
.sidebar::-webkit-scrollbar { width:8px; }
.sidebar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius:4px; }
.sidebar::-webkit-scrollbar-thumb { background-color:#667eea; border-radius:4px; }

.menu a { display:flex; align-items:center; padding:15px 30px; text-decoration:none; color:#555; font-size:16px; transition:all 0.3s ease; border-left:4px solid transparent; }
.menu a:hover,.menu a.active { color:#667eea; background:rgba(102,126,234,0.1); border-left:4px solid #667eea; }
.menu a i { margin-right:15px; }

.content { flex:1; padding:40px; background:rgba(255,255,255,0.1); backdrop-filter:blur(10px); overflow-y:auto; }

.form-container { background:rgba(255,255,255,0.95); border-radius:20px; padding:30px; max-width:600px; margin:0 auto; box-shadow:0 5px 20px rgba(0,0,0,0.1);}
.form-container h2 { text-align:center; margin-bottom:20px; color:#333; }
.form-group { margin-bottom:15px; }
label { display:block; margin-bottom:6px; font-weight:bold; color:#444; }
input, select, textarea { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; }
textarea { min-height:100px; resize:vertical; }
button { width:100%; padding:12px; font-size:16px; border:none; border-radius:8px; cursor:pointer; background:#667eea; color:white; }
button:hover { background:#5a6ddd; }
.success-msg { display:none; text-align:center; color:#28a745; margin-top:15px; }

@media (max-width:768px){ .main { flex-direction:column;} .sidebar { width:100%; order:2;} .content { order:1; padding:20px;} }
@media (max-width:480px){ .header img.logo { height:40px;} .header-right { gap:10px;} .icon,.avatar { width:32px;height:32px; font-size:14px;} .form-container { padding:15px; } }
</style>
</head>
<body>

<div class="header">
  <img src="image/logo1.gif" alt="Logo" class="logo" onclick="location.href='student_index.html'">
  <div class="header-right">
    <div class="icon"><i class="fas fa-bell"></i></div>
    <div class="avatar" onclick="toggleMenu()"><i class="fas fa-user"></i></div>
    <div id="userMenu" class="dropdown-menu">
      <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt" style="margin-right:8px;"></i>ç™»å‡º</a>
    </div>
  </div>
</div>

<div class="main">
  <div class="sidebar">
    <div class="menu">
      <a href="student_index.html"><i class="fas fa-home"></i>å­¸ç”Ÿé¦–é </a>
      <a href="student_activities.html"><i class="fas fa-calendar-alt"></i>æ´»å‹•è¡Œäº‹æ›†</a>
      <a href="student_registration.html"><i class="fas fa-user-plus"></i>ç·šä¸Šå ±å</a>
      <a href="student_activities_modify.html"><i class="fas fa-edit"></i>æ´»å‹•å ±åä¿®æ”¹</a>
      <a href="student_profile.html"><i class="fas fa-user-circle"></i>æŸ¥çœ‹å€‹äººæ´»å‹•ç´€éŒ„</a>
      <a href="student_upload.html"><i class="fas fa-cloud-upload-alt"></i>æª”æ¡ˆä¸Šå‚³</a>
      <a href="student_files.html"><i class="fas fa-folder-open"></i>æŸ¥çœ‹ä¸Šå‚³æª”æ¡ˆ</a>
      <a href="student_from.html" class="active"><i class="fas fa-chart-pie"></i>å¡«å¯«æ´»å‹•å›é¥‹</a>
      <a href="student_image.html"><i class="fas fa-image"></i>æ´»å‹•ç›¸ç°¿</a>
    </div>
  </div>

  <div class="content">
    <div class="form-container">
      <h2>æ´»å‹•å›é¥‹è¡¨å–®</h2>
      <form id="feedbackForm">
        <div class="form-group">
          <label for="activity">æ´»å‹•åç¨±</label>
          <select id="activity" required>
            <option value="">è«‹é¸æ“‡æ´»å‹•</option>
          </select>
        </div>
        <div class="form-group">
          <label for="studentName">å§“å</label>
          <input type="text" id="studentName" required>
        </div>
        <div class="form-group">
          <label for="satisfaction">æ»¿æ„åº¦ (1-5)</label>
          <select id="satisfaction" required>
            <option value="5">éå¸¸æ»¿æ„</option>
            <option value="4">æ»¿æ„</option>
            <option value="3">æ™®é€š</option>
            <option value="2">ä¸æ»¿æ„</option>
            <option value="1">éå¸¸ä¸æ»¿æ„</option>
          </select>
        </div>
        <div class="form-group">
          <label for="comment">æ„è¦‹å»ºè­°</label>
          <textarea id="comment"></textarea>
        </div>
        <button type="submit">é€å‡ºåé¥‹</button>
      </form>
      <div class="success-msg" id="successMsg">âœ… æ„Ÿè¬æ‚¨çš„åé¥‹ï¼</div>
    </div>
  </div>
</div>

<script>
// ä¸‹æ‹‰é¸å–®åŠŸèƒ½
function toggleMenu() {
  const menu = document.getElementById("userMenu");
  menu.style.display = (menu.style.display==="flex") ? "none" : "flex";
}

function logout() { 
  location.href = "login_student.html"; 
}

document.addEventListener("click",(e)=>{
  const avatar = document.querySelector(".avatar");
  const menu = document.getElementById("userMenu");
  if(!avatar.contains(e.target) && !menu.contains(e.target)){ 
    menu.style.display="none"; 
  }
});

// === æ´»å‹•å›é¥‹è¡¨å–®åŠŸèƒ½ ===
const activitySelect = document.getElementById('activity');
const feedbackForm = document.getElementById('feedbackForm');
const successMsg = document.getElementById('successMsg');

// è¼‰å…¥æ´»å‹•é¸é …
async function loadActivities() {
  try {
    console.log('ğŸ” é–‹å§‹è¼‰å…¥æ´»å‹•é¸é …...');
    const response = await fetch('student_api.php?action=get_feedback_forms');
    
    if (!response.ok) {
      throw new Error('HTTPéŒ¯èª¤: ' + response.status);
    }
    
    const result = await response.json();
    console.log('ğŸ“¦ API å›æ‡‰:', result);
    
    // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™é è¨­çš„"è«‹é¸æ“‡æ´»å‹•"ï¼‰
    activitySelect.innerHTML = '<option value="">è«‹é¸æ“‡æ´»å‹•</option>';
    
    if (result.success && result.data && result.data.length > 0) {
      result.data.forEach(form => {
        const opt = document.createElement('option');
        opt.value = form.id;
        opt.textContent = form.name;
        activitySelect.appendChild(opt);
      });
      console.log(`âœ… å·²è¼‰å…¥ ${result.data.length} å€‹æ´»å‹•`);
    } else {
      // å¦‚æœ API æ²’æœ‰è³‡æ–™ï¼Œä½¿ç”¨æ¨¡æ“¬è³‡æ–™
      console.warn('âš ï¸ API æ²’æœ‰å›å‚³æ´»å‹•è³‡æ–™ï¼Œä½¿ç”¨æ¨¡æ“¬è³‡æ–™');
      const mockActivities = [
        {id:1, name:'ç§‘å­¸ç‡Ÿ2025'},
        {id:2, name:'ç‰©ç†å¯¦é©—å·¥ä½œåŠ'},
        {id:3, name:'æ ¡åœ’ç§‘æŠ€å±•'}
      ];
      mockActivities.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        activitySelect.appendChild(opt);
      });
    }
  } catch (error) {
    console.error('âŒ è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
    alert('è¼‰å…¥æ´»å‹•åˆ—è¡¨å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
  }
}

// è¡¨å–®æäº¤è™•ç†ï¼ˆåªä¿ç•™é€™ä¸€å€‹ï¼‰
feedbackForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // ç²å–è¡¨å–®è³‡æ–™
  const activityId = activitySelect.value;
  const studentName = document.getElementById('studentName').value.trim();
  const satisfaction = document.getElementById('satisfaction').value;
  const comment = document.getElementById('comment').value.trim();
  
  // å‰ç«¯é©—è­‰
  if (!activityId) {
    alert('âŒ è«‹é¸æ“‡æ´»å‹•');
    activitySelect.focus();
    return;
  }
  
  if (!studentName) {
    alert('âŒ è«‹å¡«å¯«å§“å');
    document.getElementById('studentName').focus();
    return;
  }
  
  if (studentName.length < 2) {
    alert('âŒ å§“åè‡³å°‘éœ€è¦2å€‹å­—');
    document.getElementById('studentName').focus();
    return;
  }
  
  console.log('ğŸ“¤ æº–å‚™æäº¤å›é¥‹:', {
    activityId, studentName, satisfaction, comment
  });
  
  try {
    // å»ºç«‹è¡¨å–®è³‡æ–™
    const formData = new FormData();
    formData.append('action', 'submit_feedback');
    formData.append('activityId', activityId);
    formData.append('studentName', studentName);
    formData.append('satisfaction', satisfaction);
    formData.append('comment', comment);
    
    // ç™¼é€ API è«‹æ±‚
    const response = await fetch('student_api.php', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error('HTTPéŒ¯èª¤: ' + response.status);
    }
    
    const result = await response.json();
    console.log('ğŸ“¦ æäº¤çµæœ:', result);
    
    if (result.success) {
      // æˆåŠŸæç¤º
      successMsg.style.display = 'block';
      successMsg.textContent = 'âœ… ' + (result.message || 'æ„Ÿè¬æ‚¨çš„åé¥‹ï¼');
      
      // é‡ç½®è¡¨å–®
      feedbackForm.reset();
      
      // 3ç§’å¾Œéš±è—æˆåŠŸè¨Šæ¯
      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 3000);
    } else {
      // å¤±æ•—æç¤º
      alert('âŒ ' + (result.message || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'));
    }
    
  } catch (error) {
    console.error('âŒ æäº¤éŒ¯èª¤:', error);
    alert('âŒ æäº¤æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
  }
});

// é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
window.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸš€ é é¢è¼‰å…¥å®Œæˆ');
  loadActivities();
});
</script>

</body>
</html>
