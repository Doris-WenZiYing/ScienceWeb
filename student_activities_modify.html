<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>科學會 - 活動報名修改</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet" />
  <style>
    body, html {
      margin: 0; padding: 0;
      font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100%;
    }

    /* 頂部欄 */
    .header {
      height: 70px;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 30px; box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      position: relative; z-index: 100;
    }
    .header::before {
      content: ''; position: absolute; bottom: 0; left: 0; right: 0;
      height: 3px; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    .header img.logo { height: 50px; cursor:pointer; }
    .header-right { display: flex; align-items: center; gap: 25px; position: relative; }
    .icon, .avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    }

    /* 下拉選單 */
    .dropdown-menu {
      position: absolute;
      top: 70px;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      min-width: 140px;
      z-index: 200;
    }
    .dropdown-menu a {
      padding: 10px 15px;
      text-decoration: none;
      color: #333;
      display: block;
      font-size: 14px;
    }
    .dropdown-menu a:hover {
      background: #f5f5f5;
      color: #667eea;
    }

    /* 側邊欄 */
    .sidebar {
      width: 250px; 
      background: rgba(255,255,255,0.95); 
      backdrop-filter: blur(10px);
      display: flex; 
      flex-direction: column; 
      padding-top: 30px;
      overflow-y: auto;          
      scrollbar-width: thin;     
      scrollbar-color: #667eea rgba(0,0,0,0.1);
    }
    .sidebar::-webkit-scrollbar { width: 8px; }
    .sidebar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
    .sidebar::-webkit-scrollbar-thumb { background-color: #667eea; border-radius: 4px; }

    .menu a {
      display: flex; align-items: center; padding: 15px 30px; text-decoration: none;
      color: #555; font-size: 16px; transition: all 0.3s ease; border-left: 4px solid transparent;
    }
    .menu a:hover, .menu a.active {
      color: #667eea; background: rgba(102, 126, 234, 0.1); border-left: 4px solid #667eea;
    }
    .menu a i { margin-right: 15px; }

    /* 主體 */
    .main { display: flex; height: calc(100% - 70px); }

    /* 內容 */
    .content {
      flex: 1; padding: 40px;
      background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      overflow-y: auto;
    }

    .form-container {
      background: rgba(255,255,255,0.95);
      border-radius: 20px; padding: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      max-width: 600px; margin: 0 auto;
    }
    .form-container h2 {
      text-align: center; color: #333; margin-bottom: 30px;
    }
    label {
      display: block; margin-bottom: 8px; font-weight: 600; color: #444;
    }
    select, input[type="text"], input[type="email"] {
      width: 100%; padding: 10px 12px; margin-bottom: 20px;
      border: 1px solid #ccc; border-radius: 8px;
      font-size: 16px; box-sizing: border-box;
    }
    button {
      width: 100%; padding: 12px;
      background: #667eea; border: none; color: white;
      font-size: 18px; border-radius: 10px;
      cursor: pointer; transition: background 0.3s ease;
    }
    button:hover { background: #5a6ddd; }

    .no-records {
      text-align: center; font-size: 18px;
      color: #666; margin-top: 30px;
    }

    @media (max-width: 768px) {
      .main { flex-direction: column; }
      .sidebar { width: 100%; }
      .content { padding: 20px; }
      .form-container { max-width: 100%; }
    }
  </style>
</head>
<body>

   <div class="header">
    <img src="image/logo1.gif" alt="Logo" class="logo" onclick="location.href='student_index.html'">
    <div class="header-right">
      <div class="icon"><i class="fas fa-bell"></i></div>
      <div class="avatar" onclick="toggleMenu()"><i class="fas fa-user"></i></div>
      <div id="userMenu" class="dropdown-menu">
        <a href="student_profile.html"><i class="fas fa-cog" style="margin-right:8px;"></i>個人設定</a>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt" style="margin-right:8px;"></i>登出</a>
      </div>
    </div>
  </div>

 <div class="main">
    <div class="sidebar">
      <div class="menu">
        <a href="student_index.html"><i class="fas fa-home"></i>學生首頁</a>
        <a href="student_activities.html"><i class="fas fa-calendar-alt"></i>活動行事曆</a>
        <a href="student_registration.html"><i class="fas fa-user-plus"></i>線上報名</a>
        <a href="student_activities_modify.html" class="active"><i class="fas fa-edit"></i>活動報名修改</a>
        <a href="student_profile.html"><i class="fas fa-user-circle"></i>查看個人活動紀錄</a>
        <a href="student_upload.html"><i class="fas fa-cloud-upload-alt"></i>檔案上傳</a>
        <a href="student_files.html"><i class="fas fa-folder-open"></i>查看上傳檔案</a>
        <a href="student_from.html"><i class="fas fa-chart-pie"></i>填寫活動回饋</a>
        <a href="student_image.html"><i class="fas fa-image"></i>活動相簿</a>
      </div>
    </div>

    <div class="content">
      <div class="form-container">
        <h2><i class="fas fa-edit" style="color:#667eea;margin-right:8px;"></i>活動報名修改</h2>
        
        <!-- 修改表單 -->
        <form id="modifyForm" style="display:none;">
          <label for="registrationSelect">選擇要修改的活動</label>
          <select id="registrationSelect" name="registration" required></select>

          <label for="newName">姓名</label>
          <input type="text" id="newName" name="newName" placeholder="請輸入新的姓名" required />

          <label for="newEmail">電子郵件</label>
          <input type="email" id="newEmail" name="newEmail" placeholder="請輸入新的電子郵件" required />

          <button type="submit">送出修改</button>
        </form>

        <!-- 狀態訊息 -->
        <p id="statusMsg" class="no-records">載入中...</p>
      </div>
    </div>
  </div>

  <script>
    const registrationSelect = document.getElementById('registrationSelect');
    const statusMsg = document.getElementById('statusMsg');
    const form = document.getElementById('modifyForm');

    const MY_REGISTRATIONS_API = '/api/my-registrations'; 
    const UPDATE_REGISTRATION_API = '/api/register/';    

    async function fetchRegistrations() {
      try {
        const res = await fetch(MY_REGISTRATIONS_API);
        if (!res.ok) throw new Error('取得報名紀錄失敗');
        const registrations = await res.json();

        if (!Array.isArray(registrations) || registrations.length === 0) {
          form.style.display = 'none';
          statusMsg.textContent = '目前沒有報名的活動。';
          statusMsg.style.display = 'block';
          return;
        }

        registrations.forEach(r => {
          const option = document.createElement('option');
          option.value = r.id;
          option.textContent = `${r.eventName}（${r.name} / ${r.email}）`;
          registrationSelect.appendChild(option);
        });

        statusMsg.style.display = 'none';
        form.style.display = 'block';
      } catch (err) {
        console.error(err);
        form.style.display = 'none';
        statusMsg.textContent = '取得資料時發生錯誤，請稍後再試。';
        statusMsg.style.display = 'block';
      }
    }

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const selectedId = registrationSelect.value;
      const newName = document.getElementById('newName').value.trim();
      const newEmail = document.getElementById('newEmail').value.trim();

      if (!selectedId || !newName || !newEmail) {
        alert('請填寫完整資料');
        return;
      }

      try {
        const res = await fetch(UPDATE_REGISTRATION_API + selectedId, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName, email: newEmail })
        });
        if (!res.ok) throw new Error('修改失敗');
        alert('修改成功！');
        form.reset();
      } catch (err) {
        console.error(err);
        alert('修改時發生錯誤，請稍後再試。');
      }
    });

    fetchRegistrations();

    // 下拉選單功能
    function toggleMenu() {
      const menu = document.getElementById("userMenu");
      menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
    }

    function logout() {
      location.href = "login_student.html";
    }

    document.addEventListener("click", (e)=>{
      const avatar = document.querySelector(".avatar");
      const menu = document.getElementById("userMenu");
      if(!avatar.contains(e.target) && !menu.contains(e.target)){
        menu.style.display = "none";
      }
    });
  </script>
</body>
</html>
